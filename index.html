<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hydrologie ‚Äì Estimation Myer avec proxy Render</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body{margin:0;background:#0b1020;color:#f5f7fb;font:15px system-ui}
    header{display:flex;align-items:center;justify-content:space-between;
      padding:10px 14px;border-bottom:1px solid #1f2742;background:#0e1430}
    header h1{font-size:18px;margin:0}
    #app{display:grid;grid-template-columns:400px 1fr;min-height:calc(100vh - 58px)}
    #sidebar{padding:12px;border-right:1px solid #1f2742;background:#0e1430;overflow:auto}
    #map{width:100%;height:calc(100vh - 58px)}
    fieldset{border:1px solid #24304f;border-radius:12px;padding:10px;margin-bottom:12px}
    legend{color:#9aa3b2}
    input,button{width:100%;padding:8px;border-radius:10px;
      border:1px solid #2a3558;background:#10183a;color:#f5f7fb;margin-top:6px}
    button.primary{background:linear-gradient(135deg,#6ee7b7,#93c5fd);color:#0b1020;
      font-weight:600;border:none;cursor:pointer}
    .stat{display:flex;justify-content:space-between;padding:6px 8px;
      background:#0b1536;border:1px solid #1e2a4e;border-radius:10px;margin:4px 0}
    .hint{font-size:12px;color:#9aa3b2}
    #chartBox{background:#0b1536;border:1px solid #1e2a4e;
      border-radius:12px;padding:10px;margin-top:12px}
  </style>
</head>
<body>

<header>
  <h1>üíß Estimation du d√©bit ‚Äì M√©thode de Myer</h1>
  <span>GitHub Pages + Proxy Render</span>
</header>

<div id="app">
  <aside id="sidebar">

    <fieldset>
      <legend>1) Choix du point</legend>
      <div class="hint">Cliquez sur la carte pour d√©finir l‚Äôexutoire</div>
      <input id="lat" type="number" placeholder="Latitude"/>
      <input id="lng" type="number" placeholder="Longitude"/>
      <button id="btnWs" class="primary">‚öôÔ∏è D√©limiter bassin</button>
      <div id="wsStats"></div>
    </fieldset>

    <fieldset>
      <legend>2) Stations voisines</legend>
      <label>Distance de recherche (km)</label>
      <input id="distance" type="number" value="40000"/>
      <button id="btnStations" class="primary">üîé Chercher stations</button>
      <div id="stationsList" class="hint">‚Äî</div>
    </fieldset>

    <fieldset>
      <legend>3) P√©riode</legend>
      <label>D√©but</label><input type="date" id="startDate"/>
      <label>Fin</label><input type="date" id="endDate"/>
    </fieldset>

    <fieldset>
      <legend>4) Calcul Myer</legend>
      <button id="btnMyer" class="primary">üìä Calculer Myer</button>
      <button id="btnCSV" disabled>‚¨áÔ∏è Export CSV</button>
      <div id="resultMyer"></div>
    </fieldset>

    <div id="chartBox" style="display:none;">
      <canvas id="myChart"></canvas>
    </div>

  </aside>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ------------ CONFIG ----------------
const proxyBase="https://hydro-watershed-myer-model-render-proxy.onrender.com";

// ------------ MAP INIT ----------------
const map=L.map('map').setView([46.5,2.5],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);

let outletMarker=null, wsLayer=null, watershed=null, stations=[], chart=null;

// ------------ EXUTOIRE ----------------
map.on('click',(e)=>{
  const {lat,lng}=e.latlng;
  document.getElementById('lat').value=lat.toFixed(5);
  document.getElementById('lng').value=lng.toFixed(5);
  if(outletMarker) map.removeLayer(outletMarker);
  outletMarker=L.marker([lat,lng]).addTo(map);
});

// ------------ BASSIN VERSANT ----------------
document.getElementById('btnWs').onclick= async ()=>{
  const lat=parseFloat(document.getElementById('lat').value),
        lng=parseFloat(document.getElementById('lng').value);
  if(isNaN(lat)||isNaN(lng)) return alert("Coordonn√©es invalides");
  const url=`https://mghydro.com/app/watershed_api?lat=${lat}&lng=${lng}&precision=high`;
  const res=await fetch(url); const geo=await res.json();
  watershed=geo.features[0];
  if(wsLayer) map.removeLayer(wsLayer);
  wsLayer=L.geoJSON(watershed,{style:{color:'orange',weight:2,fillOpacity:0.2}}).addTo(map);
  map.fitBounds(wsLayer.getBounds());
  const area=turf.area(watershed)/1e6;
  document.getElementById('wsStats').innerHTML=
    `<div class="stat"><div>Surface</div><div>${area.toFixed(1)} km¬≤</div></div>`;
};

// ------------ STATIONS VIA PROXY ----------------
document.getElementById('btnStations').onclick=async ()=>{
  const lat=parseFloat(document.getElementById('lat').value),
        lng=parseFloat(document.getElementById('lng').value),
        dist=parseFloat(document.getElementById('distance').value||30000);
  if(!lat||!lng) return alert("Choisissez un exutoire");

  const url=`${proxyBase}/stations?longitude=${lng}&latitude=${lat}&distance=${dist}`;
  console.log("‚û°Ô∏è Appel stations:", url);
  const res=await fetch(url);
  const js=await res.json();
  console.log("Stations r√©ponse:", js);

  if(!js.data || !js.data.length){
    alert("‚ö†Ô∏è Aucune station trouv√©e (√©largissez la distance ou changez de point)");
    return;
  }
  stations=js.data;

  // Nettoyer anciens markers stations
  map.eachLayer(layer=>{
    if(layer.options && layer.options.color==='blue') map.removeLayer(layer);
  });

  // afficher markers
  stations.forEach(st=>{
    const lat=st.latitude_station;
    const lon=st.longitude_station;
    if(lat && lon){
      L.circleMarker([lat,lon],{color:'blue',radius:6})
        .addTo(map)
        .bindPopup(`<b>${st.libelle_station}</b><br/>${st.libelle_cours_eau}<br/>
        Code: ${st.code_station}<br/>Surface: ${st.surface_bv_km2||"?"} km¬≤`);
    }
  });

  document.getElementById('stationsList').textContent=`${stations.length} stations trouv√©es`;
};

// ------------ CALCUL MYER ----------------
document.getElementById('btnMyer').onclick=async ()=>{
  if(!watershed) return alert("D√©limitez un bassin avant");
  const start=document.getElementById('startDate').value;
  const end=document.getElementById('endDate').value;
  if(!start||!end) return alert("Choisissez une p√©riode");

  const basinArea=turf.area(watershed)/1e6;
  let seriesAll=[];
  for(const s of stations){
    try{
      const url=`${proxyBase}/obs?code_entite=${s.code_station}&grandeur_hydro=Qmj&date_debut=${start}&date_fin=${end}`;
      console.log("‚û°Ô∏è Appel obs:",url);
      const res=await fetch(url); const js=await res.json();
      if(js && js.data){
        const obs=js.data.map(o=>({date:o.date_obs_elab,q:parseFloat(o.resultat_obs)}));
        if(obs.length) seriesAll.push({station:s,series:obs});
      }
    }catch(e){console.warn("Erreur obs",s.code_station);}
  }
  if(!seriesAll.length) return alert("Pas de s√©ries Qmj trouv√©es");

  const dates=seriesAll[0].series.map(o=>o.date);
  const result=dates.map(d=>{
    const qStations=seriesAll.map(s=>{
      const o=s.series.find(x=>x.date===d);
      if(!o||isNaN(o.q)) return null;
      const As=s.station.surface_bv_km2||basinArea;
      return o.q*(basinArea/As);
    }).filter(x=>x!==null);
    return {date:d,q:qStations.length?qStations.reduce((a,b)=>a+b,0)/qStations.length:null};
  });

  const meanQ=result.reduce((a,r)=>a+(r.q||0),0)/result.length;
  const maxQ=Math.max(...result.filter(r=>r.q!==null).map(r=>r.q));

  document.getElementById('resultMyer').innerHTML=
    `<div class="stat"><div>Stations utilis√©es</div><div>${seriesAll.length}</div></div>
     <div class="stat"><div>Q moyen</div><div>${meanQ.toFixed(2)} m¬≥/s</div></div>
     <div class="stat"><div>Q max</div><div>${maxQ.toFixed(2)} m¬≥/s</div></div>`;

  // Export CSV
  let csv="date,q_m3s\n"+result.map(r=>`${r.date},${r.q}`).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const btn=document.getElementById('btnCSV');
  btn.disabled=false;
  btn.onclick=()=>{
    const a=document.createElement("a"); a.href=url; a.download="debits_myer.csv"; a.click();
  };

  // Graph
  const labels=result.map(r=>r.date);
  const values=result.map(r=>r.q);
  document.getElementById('chartBox').style.display="block";
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById('myChart'),{
    type:'line',
    data:{labels,datasets:[{label:'D√©bit estim√© Myer (m¬≥/s)',data:values,
      borderColor:'#6ee7b7',backgroundColor:'rgba(110,231,183,0.2)',tension:0.2}]},
    options:{scales:{x:{ticks:{color:'#eee'}},y:{ticks:{color:'#eee'}}}}
  });
};
</script>
</body>
</html>
