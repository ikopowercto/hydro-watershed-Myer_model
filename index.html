<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>D√©bits estim√©s - Myer avec CSV Hydroportail</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body{margin:0;background:#0b1020;color:#f5f7fb;font:15px system-ui,Segoe UI,Roboto}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid #1f2742;background:#0e1430}
    header h1{font-size:18px;margin:0}
    #app{display:grid;grid-template-columns:400px 1fr;min-height:calc(100vh - 58px)}
    #sidebar{padding:12px;border-right:1px solid #1f2742;background:#0e1430;overflow:auto}
    #map{width:100%;height:calc(100vh - 58px)}
    fieldset{border:1px solid #24304f;border-radius:12px;padding:10px 12px;margin:0 0 12px}
    legend{color:#9aa3b2}
    label{display:block;margin:6px 0 2px}
    input, select, button{width:100%;padding:8px;border-radius:10px;border:1px solid #2a3558;background:#10183a;color:#f5f7fb}
    button.primary{background:linear-gradient(135deg,#6ee7b7,#93c5fd);color:#0b1020;font-weight:600;border:none;cursor:pointer;margin-top:6px}
    .pill{display:inline-block;border:1px solid #2a3558;border-radius:999px;padding:4px 8px;margin-right:6px;font-size:12px}
    .stat{display:flex;justify-content:space-between;padding:6px 8px;background:#0b1536;border:1px solid #1e2a4e;border-radius:10px;margin:4px 0}
    .hint{font-size:12px;color:#9aa3b2}
    #chartBox{background:#0b1536;border:1px solid #1e2a4e;border-radius:12px;padding:10px;margin-top:12px}
    .stationItem{margin:4px 0;padding:6px;border-radius:6px;background:#121b3a}
  </style>
</head>
<body>

<header>
  <h1>üíß D√©bits estim√©s (M√©thode de Myer, CSV Hydroportail)</h1>
  <div>
    <span class="pill">Delineator API</span>
    <span class="pill">Stations Hubeau</span>
    <span class="pill">Hydro CSV Import</span>
    <span class="pill">Chart.js</span>
  </div>
</header>

<div id="app">
  <aside id="sidebar">
    
    <fieldset>
      <legend>1) Point d'√©tude</legend>
      <label>Latitude / Longitude</label>
      <input id="lat" type="number" step="any" placeholder="Latitude" />
      <input id="lng" type="number" step="any" placeholder="Longitude" />
      <button id="btnWs" class="primary">‚öôÔ∏è D√©limiter le bassin</button>
      <div id="wsStats"></div>
    </fieldset>

    <fieldset>
      <legend>2) Stations voisines</legend>
      <button id="btnStations" class="primary">üîé Trouver les stations</button>
      <div id="stationsList" class="hint">Aucune.</div>
    </fieldset>

    <fieldset>
      <legend>3) Importer vos donn√©es Hydroportail</legend>
      <div class="hint">T√©l√©chargez les CSV depuis chaque station (Hydroportail) puis importez ici</div>
      <label>Importer fichiers CSV (plusieurs autoris√©s)</label>
      <input type="file" id="csvFiles" multiple accept=".csv"/>
    </fieldset>

    <fieldset>
      <legend>4) Calcul Myer</legend>
      <button id="btnMyer" class="primary">üìà Calculer</button>
      <button id="btnCSV" disabled>‚¨áÔ∏è T√©l√©charger CSV</button>
      <div id="resultMyer"></div>
    </fieldset>

    <div id="chartBox" style="display:none;">
      <canvas id="myChart"></canvas>
    </div>
  </aside>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const map = L.map('map').setView([46.5,2.5],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:18, attribution:'&copy; OpenStreetMap'
}).addTo(map);

let outletMarker=null, wsLayer=null, watershed=null, stations=[], chart=null;
let importedSeries=[];

map.on('click',(e)=>{
  document.getElementById('lat').value=e.latlng.lat.toFixed(5);
  document.getElementById('lng').value=e.latlng.lng.toFixed(5);
  if(outletMarker) map.removeLayer(outletMarker);
  outletMarker=L.marker(e.latlng).addTo(map);
});

// 1. D√©limitation
document.getElementById('btnWs').onclick= async ()=>{
  const lat=parseFloat(document.getElementById('lat').value),
        lng=parseFloat(document.getElementById('lng').value);
  if(isNaN(lat)||isNaN(lng)) return alert("Coordonn√©es invalides");
  const url=`https://mghydro.com/app/watershed_api?lat=${lat}&lng=${lng}&precision=high`;
  try{
    const res=await fetch(url); const geo=await res.json();
    watershed=geo.features[0];
    if(wsLayer) map.removeLayer(wsLayer);
    wsLayer=L.geoJSON(watershed,{style:{color:'orange',weight:2,fillOpacity:0.2}}).addTo(map);
    map.fitBounds(wsLayer.getBounds());
    const area=turf.area(watershed)/1e6;
    document.getElementById('wsStats').innerHTML=`<div class="stat"><div>Surface</div><div>${area.toFixed(1)} km¬≤</div></div>`;
  }catch(err){ alert("√âchec calcul bassin"); }
};

// 2. Stations voisines
document.getElementById('btnStations').onclick= async ()=>{
  if(!watershed) return alert("D√©limitez un bassin");
  const lat=parseFloat(document.getElementById('lat').value),
        lon=parseFloat(document.getElementById('lng').value);
  const url=`https://hubeau.eaufrance.fr/api/v1/hydrometrie/referentiel/stations?latitude=${lat}&longitude=${lon}&distance=30000`;
  try{
    const res=await fetch(url); const js=await res.json();
    stations=js.data;
    if(!stations.length){document.getElementById('stationsList').innerHTML="Aucune station trouv√©e.";}
    else{
      document.getElementById('stationsList').innerHTML=stations.map(s=>
        `<div class="stationItem">
          <b>${s.libelle_station}</b><br/>
          <span class="hint">${s.libelle_cours_eau}</span><br/>
          Surface : ${s.superficie_bv||'?'} km¬≤<br/>
          <a href="https://hydro.eaufrance.fr/station/${s.code_station}" target="_blank">üìÇ T√©l√©charger CSV</a>
        </div>`
      ).join('');
    }
  }catch(err){console.error(err); alert("Erreur API Hubeau");}
};

// 3. Import CSV Hydroportail (intelligent)
document.getElementById('csvFiles').addEventListener('change', (evt)=>{
  importedSeries=[];
  const files=evt.target.files;
  for(const file of files){
    const reader=new FileReader();
    reader.onload=(e)=>{
      const text=e.target.result;
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
      // chercher l'en-t√™te (derni√®re ligne avant les donn√©es commen√ßant par AAAA-..)
      const headLine=lines.find(l=>l.toLowerCase().includes("date"));
      const headers=headLine.split(";");
      const idxDate=headers.findIndex(h=>/date/i.test(h));
      const idxQ=headers.findIndex(h=>/(q|d√©bit)/i.test(h));
      if(idxDate<0||idxQ<0){alert("Impossible de trouver colonnes date/Q dans "+file.name);return;}
      const dataLines=lines.slice(lines.indexOf(headLine)+1);
      const series=dataLines.map(row=>{
        const cols=row.split(";");
        const date=cols[idxDate];
        const q=parseFloat((cols[idxQ]||"").replace(",","."));
        return {date,q:!isNaN(q)?q:null};
      }).filter(r=>r.q!==null);
      importedSeries.push({name:file.name, series});
      console.log("Import√© ",file.name,series.length," valeurs");
    };
    reader.readAsText(file);
  }
});

// 4. Calcul Myer
document.getElementById('btnMyer').onclick=()=>{
  if(!watershed) return alert("D√©limitez un bassin");
  if(!importedSeries.length) return alert("Importez d'abord vos CSV Hydroportail");
  const basinArea=turf.area(watershed)/1e6;
  // collecter toutes les dates uniques
  let allDates=new Set();
  importedSeries.forEach(s=>s.series.forEach(r=>allDates.add(r.date)));
  const dates=[...allDates].sort();
  let result=[];
  for(const d of dates){
    const qStations=importedSeries.map(s=>{
      const r=s.series.find(rr=>rr.date===d);
      return r? r.q*(basinArea/(s.area||basinArea)) : null;
    }).filter(x=>x!==null);
    const qEst=qStations.length? qStations.reduce((a,b)=>a+b,0)/qStations.length : null;
    result.push({date:d,q:qEst});
  }
  const meanQ=result.reduce((a,r)=>a+(r.q||0),0)/result.length;
  const maxQ=Math.max(...result.filter(r=>r.q!==null).map(r=>r.q));
  document.getElementById('resultMyer').innerHTML=`
    <div class="stat"><div>Fichiers utilis√©s</div><div>${importedSeries.length}</div></div>
    <div class="stat"><div>Q moyen</div><div>${meanQ.toFixed(2)} m¬≥/s</div></div>
    <div class="stat"><div>Q max</div><div>${maxQ.toFixed(2)} m¬≥/s</div></div>`;
  // export CSV
  let csv="date,q_m3s\n"+result.map(r=>`${r.date},${r.q}`).join("\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const btn=document.getElementById('btnCSV');
  btn.disabled=false;
  btn.onclick=()=>{
    const a=document.createElement("a");
    a.href=url; a.download="debits_myer.csv"; a.click();
  };
  // Chart
  const labels=result.map(r=>r.date);
  const values=result.map(r=>r.q);
  document.getElementById('chartBox').style.display="block";
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById('myChart'),{
    type:'line',
    data:{labels,datasets:[{
      label:'D√©bit estim√© (m¬≥/s)', data:values,
      borderColor:'#6ee7b7', backgroundColor:'rgba(110,231,183,0.2)', tension:0.2
    }]},
    options:{responsive:true,
      plugins:{legend:{labels:{color:'#f5f7fb'}}},
      scales:{x:{ticks:{color:'#ccc'}},y:{ticks:{color:'#ccc'}}}}
  });
};
</script>
</body>
</html>
